{% extends "base.html" %}

{% block title %}AI Hỗ trợ học tập - EduLearn{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-robot text-primary me-2"></i>AI Hỗ trợ học tập</h2>
    <div class="badge bg-primary fs-6">
        <i class="fas fa-brain me-1"></i>Trí tuệ nhân tạo
    </div>
</div>

<!-- AI Metrics Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="chart-container text-center">
            <div class="ai-metric-icon mb-3">
                <i class="fas fa-chart-line fa-2x text-primary"></i>
            </div>
            <h4 class="text-primary">{{ "%.1f"|format(metrics.avg_score) }}</h4>
            <p class="text-muted mb-0">Điểm trung bình</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="chart-container text-center">
            <div class="ai-metric-icon mb-3">
                <i class="fas fa-sign-in-alt fa-2x text-success"></i>
            </div>
            <h4 class="text-success">{{ metrics.login_count }}</h4>
            <p class="text-muted mb-0">Lần đăng nhập</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="chart-container text-center">
            <div class="ai-metric-icon mb-3">
                <i class="fas fa-tasks fa-2x text-warning"></i>
            </div>
            <h4 class="text-warning">{{ metrics.assignments_completed }}</h4>
            <p class="text-muted mb-0">Bài tập hoàn thành</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="chart-container text-center">
            <div class="ai-metric-icon mb-3">
                <i class="fas fa-book fa-2x text-info"></i>
            </div>
            <h4 class="text-info">{{ metrics.courses_enrolled }}</h4>
            <p class="text-muted mb-0">Khóa học đăng ký</p>
        </div>
    </div>
</div>

<!-- AI Analysis Results -->
<div class="row">
    {% if role == 'teacher' %}
    <!-- Teacher View -->
    <div class="col-12">
        <div class="chart-container mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-brain text-primary me-2"></i>Phân tích AI cho giảng viên</h5>
                <div class="d-flex align-items-center">
                    <form method="GET" class="d-flex align-items-center me-3" style="gap:0.5rem;">
                        <label class="mb-0 small">Lọc rủi ro:</label>
                        <select name="risk" class="form-select form-select-sm" style="width:170px">
                            <option value="all" {% if selected_risk == 'all' %}selected{% endif %}>Tất cả</option>
                            <option value="high" {% if selected_risk == 'high' %}selected{% endif %}>Nguy cơ cao</option>
                            <option value="medium" {% if selected_risk == 'medium' %}selected{% endif %}>Nguy cơ trung bình</option>
                            <option value="low" {% if selected_risk == 'low' %}selected{% endif %}>Nguy cơ thấp</option>
                        </select>
                        <button class="btn btn-outline-primary btn-sm" type="submit">Áp dụng</button>
                    </form>

                    <div class="d-flex" style="gap:0.5rem;">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewAllStudents()">
                            <i class="fas fa-users me-1"></i> Xem tất cả
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="viewClassAverage()">
                            <i class="fas fa-chart-bar me-1"></i> Trung bình lớp
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-lightbulb me-2"></i>Tổng quan lớp học
                </h6>
                <p class="mb-0">Tổng số sinh viên: <strong>{{ total_students }}</strong> | Điểm trung bình lớp: <strong>{{ "%.1f"|format(metrics.avg_score) }}</strong></p>
            </div>
            
            <!-- Student List -->
            <h6 class="mt-4 mb-3">Danh sách sinh viên và gợi ý AI:</h6>
            <div class="row">
                {% for student_data in student_analytics %}
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-user-graduate me-1"></i>{{ student_data.student.username }}
                                </h6>
                                <span class="badge bg-{{ 'success' if student_data.avg_score >= 8 else 'warning' if student_data.avg_score >= 5 else 'danger' }}">
                                    {{ student_data.avg_score }}
                                </span>
                            </div>
                            <p class="card-text small text-muted mb-2">{{ student_data.ai_advice }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">
                                    <i class="fas fa-sign-in-alt me-1"></i>{{ student_data.login_count }} lần đăng nhập
                                </small>
                                <a href="{{ url_for('teacher_view_student', student_id=student_data.student.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye me-1"></i>Chi tiết
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- Student View -->
    <div class="col-md-8">
        <div class="chart-container mb-4">
            <h5><i class="fas fa-brain text-primary me-2"></i>Phân tích AI</h5>
            <p class="text-muted">Dựa trên dữ liệu học tập của bạn, AI đã phân tích và đưa ra các gợi ý cá nhân hóa:</p>
            
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-lightbulb me-2"></i>Gợi ý từ AI
                </h6>
                <p class="mb-0">{{ ai_advice }}</p>
            </div>
            
            <h6 class="mt-4 mb-3">Khuyến nghị hành động:</h6>
            <div class="row">
                {% for recommendation in recommendations %}
                <div class="col-md-6 mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span>{{ recommendation }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
        
        <!-- Learning Path Recommendation -->
        <div class="chart-container">
            <h5><i class="fas fa-route text-success me-2"></i>Lộ trình học tập được đề xuất</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-play-circle me-2"></i>Bước tiếp theo
                            </h6>
                            <p class="card-text">Dựa trên tiến độ hiện tại, bạn nên:</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Hoàn thành bài tập còn lại</li>
                                <li><i class="fas fa-check text-success me-2"></i>Tham gia thảo luận nhóm</li>
                                <li><i class="fas fa-check text-success me-2"></i>Chuẩn bị cho bài kiểm tra</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h6 class="card-title text-warning">
                                <i class="fas fa-clock me-2"></i>Lịch học tối ưu
                            </h6>
                            <p class="card-text">AI đề xuất lịch học:</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-calendar text-info me-2"></i>Thứ 2,4,6: 19:00-21:00</li>
                                <li><i class="fas fa-calendar text-info me-2"></i>Cuối tuần: Ôn tập</li>
                                <li><i class="fas fa-calendar text-info me-2"></i>Nghỉ ngơi đầy đủ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- AI Chat Assistant -->
        <div class="chart-container mb-4">
            <h5><i class="fas fa-comments text-primary me-2"></i>Trợ lý AI</h5>
            <div class="ai-chat-container" id="supportAiChatContainer" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 1rem; border-radius: 0.375rem; background-color: #f8f9fa;">
                <div class="ai-message mb-3">
                    <div class="d-flex">
                        <div class="ai-avatar me-2" style="width: 30px; height: 30px; font-size: 0.7rem;">AI</div>
                        <div>
                            <strong>AI Assistant</strong>
                            <p class="mb-1">Xin chào {{ user.username }}! Tôi là trợ lý AI của bạn. Hãy đặt câu hỏi về học tập hoặc giảng dạy, tôi sẽ hỗ trợ ngay.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Nhập câu hỏi cho AI..." id="supportAiChatInput">
                    <button class="btn btn-primary" type="button" id="supportAiChatSend">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="chart-container">
            <h5><i class="fas fa-bolt text-warning me-2"></i>Hành động nhanh</h5>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" onclick="generateStudyPlan()">
                    <i class="fas fa-calendar-alt me-2"></i>Tạo lịch học
                </button>
                <button class="btn btn-outline-success" onclick="analyzeProgress()">
                    <i class="fas fa-chart-bar me-2"></i>Phân tích tiến độ
                </button>
                <button class="btn btn-outline-info" onclick="getRecommendations()">
                    <i class="fas fa-lightbulb me-2"></i>Gợi ý học tập
                </button>
                <button class="btn btn-outline-warning" onclick="setGoals()">
                    <i class="fas fa-target me-2"></i>Đặt mục tiêu
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.ai-metric-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    color: white;
}

.ai-avatar, .user-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.user-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}
</style>

<script>
let supportAiChatMessageCounter = 0;
let supportAiChatIsSending = false;

function supportFormatMessageText(text) {
    return text.replace(/\n/g, '<br>');
}

function supportAddMessageToChat(message, sender, options = {}) {
    const chatContainer = document.getElementById('supportAiChatContainer');
    if (!chatContainer) {
        return null;
    }

    const messageDiv = document.createElement('div');
    const messageId = `support-ai-message-${supportAiChatMessageCounter++}`;
    messageDiv.id = messageId;
    messageDiv.className = sender === 'user' ? 'user-message mb-3' : 'ai-message mb-3';

    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <div class="text-end">
                    <strong>{{ user.username }}</strong>
                    <p class="mb-1">${supportFormatMessageText(message)}</p>
                </div>
                <div class="user-avatar ms-2" style="width: 30px; height: 30px; font-size: 0.7rem;">{{ user.username[:2].upper() }}</div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="d-flex">
                <div class="ai-avatar me-2" style="width: 30px; height: 30px; font-size: 0.7rem;">AI</div>
                <div>
                    <strong>AI Assistant</strong>
                    <p class="mb-1">${supportFormatMessageText(message)}</p>
                </div>
            </div>
        `;
    }

    if (options.isPlaceholder) {
        messageDiv.dataset.placeholder = 'true';
    }

    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return messageId;
}

function supportUpdateMessageContent(messageId, newContent) {
    const messageDiv = document.getElementById(messageId);
    if (!messageDiv) {
        return;
    }

    const contentParagraph = messageDiv.querySelector('p.mb-1');
    if (contentParagraph) {
        contentParagraph.innerHTML = supportFormatMessageText(newContent);
    }
    messageDiv.dataset.placeholder = 'false';
}

function supportToggleChatControls(disabled) {
    const input = document.getElementById('supportAiChatInput');
    const sendButton = document.getElementById('supportAiChatSend');
    if (input) {
        input.disabled = disabled;
    }
    if (sendButton) {
        sendButton.disabled = disabled;
    }
}

async function supportSendAIMessage() {
    if (supportAiChatIsSending) {
        return;
    }

    const input = document.getElementById('supportAiChatInput');
    if (!input) {
        return;
    }

    const message = input.value.trim();
    if (!message) {
        return;
    }

    supportAddMessageToChat(message, 'user');
    input.value = '';

    supportAiChatIsSending = true;
    supportToggleChatControls(true);

    const placeholderId = supportAddMessageToChat('AI đang phân tích câu hỏi của bạn...', 'ai', { isPlaceholder: true });

    try {
        const response = await fetch('{{ url_for("ai_chat_api") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        if (!response.ok || !data.response) {
            throw new Error(data.error || 'Không nhận được phản hồi hợp lệ từ AI.');
        }

        supportUpdateMessageContent(placeholderId, data.response);
    } catch (error) {
        supportUpdateMessageContent(placeholderId, 'Xin lỗi, hiện tại trợ lý AI chưa thể phản hồi. Vui lòng thử lại sau.');
    } finally {
        supportAiChatIsSending = false;
        supportToggleChatControls(false);
    }
}

function generateStudyPlan() {
    alert('AI đang tạo lịch học cá nhân hóa cho bạn...');
}

function analyzeProgress() {
    alert('AI đang phân tích tiến độ học tập của bạn...');
}

function getRecommendations() {
    alert('AI đang tạo gợi ý học tập dựa trên dữ liệu của bạn...');
}

function setGoals() {
    alert('AI đang giúp bạn đặt mục tiêu học tập SMART...');
}

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('supportAiChatInput');
    const sendButton = document.getElementById('supportAiChatSend');

    if (sendButton) {
        sendButton.addEventListener('click', supportSendAIMessage);
    }

    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                supportSendAIMessage();
            }
        });
    }
});

// Teacher-specific functions
function viewAllStudents() {
    window.location.href = "{{ url_for('users') }}";
}

function viewClassAverage() {
    alert('Hiển thị điểm trung bình của tất cả sinh viên trong lớp');
}

const isTeacherView = "{{ role }}" === 'teacher';

if (isTeacherView) {
    window.sendMessageToStudent = function(studentId) {
        alert(`Gửi tin nhắn cho sinh viên ID: ${studentId}`);
    };

    window.scheduleMeeting = function(studentId) {
        alert(`Đặt lịch hẹn với sinh viên ID: ${studentId}`);
    };
}
</script>
{% endblock %}
